# AI Context & Navigation Guide

## Project Identity
- **Name**: Twitch Stream Healer
- **Type**: Userscript (Browser Extension)
- **Target**: Twitch.tv
- **Purpose**: Heal stream playback after uBlock Origin blocks ad segments
- **Environment**: Browser (Tampermonkey/Violentmonkey), No Node.js runtime in production.

## Core Constraints
1.  **Monolithic Output**: All modules in `src/` are bundled into a single file `dist/code.js`.
2.  **No External Dependencies**: The final script must be self-contained. No `npm install` dependencies in the output.
3.  **DOM Volatility**: Twitch's DOM changes frequently. Video element selectors are simple (`video`).
4.  **Passive Approach**: Only intervene when playback is definitively stuck. Let the player self-heal when possible.

## Key Directories for AI
- `src/core/orchestrators/`: **Start here**. `CoreOrchestrator.js` (entry point) and `StreamHealer.js` (main logic).
- `src/core/playback/`: Playback monitoring + stall detection helpers.
- `src/core/recovery/`: Heal pipeline, backoff, failover, recovery policies.
- `src/core/candidate/`: Candidate scoring/selection and probation logic.
- `src/core/external/`: Console/network signal handlers.
- `src/core/video/`: Video discovery + monitor registry.
- `src/recovery/`: Buffer analysis (`BufferGapFinder.js`) and seeking (`LiveEdgeSeeker.js`).
- `src/monitoring/`: Logging infrastructure.
- `docs/ARCHITECTURE.md`: **Truth**. Always cross-reference this for module interactions.

## Hot Paths (read first)
- Stall detect: `PlaybackWatchdog.tick()` -> `PlaybackStateTracker` -> `StreamHealer.onStall()`
- Heal attempt: `StreamHealer.attemptHeal()` -> `HealPipeline.attemptHeal()` -> `HealPointPoller.pollForHealPoint()` -> `LiveEdgeSeeker.seekAndPlay()`
- No-heal-point: `HealPipeline.attemptHeal()` -> `RecoveryManager.handleNoHealPoint()` -> `NoHealPointPolicy.handleNoHealPoint()`
- Play error: `HealPipeline.attemptHeal()` -> `RecoveryManager.handlePlayFailure()` -> `PlayErrorPolicy.handlePlayFailure()`
- Candidate switch: `CandidateSelector.evaluateCandidates()` -> `CandidateDecision.decide()` -> `CandidateSwitchPolicy.shouldSwitch()`
- Failover: `RecoveryManager.handleNoHealPoint()/handlePlayFailure()` -> `FailoverManager.attemptFailover()`

## Common Tasks & Files
- **Fixing Heal Logic**: Check `src/core/orchestrators/StreamHealer.js`.
- **Buffer Analysis Issues**: Check `src/recovery/BufferGapFinder.js`.
- **Seek Failures**: Check `src/recovery/LiveEdgeSeeker.js`.
- **Adding Logs**: Use `src/monitoring/Logger.js`.
- **Verification + Build**: After changes run `npm.cmd run agent:verify` (tests + build + status; build bumps version + generates dist).
- **Workflow + verification**: See `AGENTS.md`.

## Generated Artifacts
- `dist/code.js` is generated output; do not edit by hand.
- `build/version.txt` is generated by `build/build.js` (via `npm.cmd run build`).
- The load-order list in `docs/ARCHITECTURE.md` is maintained by `build/sync-docs.js` from `build/manifest.json` (generated).
- `docs/CONFIG.md` and `docs/LOG_TAGS.md` are generated by `build/sync-docs.js`.

## Data Notes
- `data/patterns.json` is currently not referenced by `src/` (reserved for future use).

## "Gotchas"
- **Video.buffered**: This is a `TimeRanges` object, not an array. Must iterate with `.start(i)` and `.end(i)`.
- **Readonly Properties**: `video.buffered`, `video.readyState` are readonly. Tests must use `Object.defineProperty()`.
- **window object**: We run in page context via userscript, full access to DOM and video elements.

## Navigation Map
| Feature | Primary Module | Related Modules |
| :--- | :--- | :--- |
| **Stall Detection** | `StreamHealer` | `BufferGapFinder.isBufferExhausted` |
| **Heal Point Finding** | `BufferGapFinder` | - |
| **Seeking** | `LiveEdgeSeeker` | - |
| **Logging** | `Logger` | `Instrumentation` |

## Ownership Map
Use this to route changes quickly.

### Orchestrators
- `src/core/orchestrators/CoreOrchestrator.js`
- `src/core/orchestrators/MonitoringOrchestrator.js`
- `src/core/orchestrators/RecoveryOrchestrator.js`
- `src/core/orchestrators/StreamHealer.js`

### Playback monitoring
- `src/core/playback/PlaybackMonitor.js`
- `src/core/playback/PlaybackWatchdog.js`
- `src/core/playback/PlaybackStateTracker.js`
- `src/core/playback/PlaybackEventHandlers.js`

### Recovery and heal pipeline
- `src/core/recovery/HealPipeline.js`
- `src/core/recovery/HealPointPoller.js`
- `src/core/recovery/RecoveryManager.js`
- `src/core/recovery/FailoverManager.js`

### Candidate selection
- `src/core/candidate/CandidateSelector.js`
- `src/core/candidate/CandidateScorer.js`
- `src/core/candidate/CandidateSwitchPolicy.js`

### External signals
- `src/core/external/ExternalSignalRouter.js`
- `src/core/external/ExternalSignalHandlerStall.js`
- `src/core/external/ExternalSignalHandlerAsset.js`

### Logging and reporting
- `src/monitoring/Logger.js`
- `src/monitoring/LogEvents.js`
- `src/monitoring/LogTagRegistry.js`
- `src/monitoring/ReportGenerator.js`

## Debugging Tools
The following global functions are exposed for debugging:
- `window.exportTwitchAdLogs()`: Downloads report (healer + metrics + merged script/console logs).

## Docs Index

### Start here
- `AGENTS.md`
- `docs/AI_CONTEXT.md`
- `docs/ARCHITECTURE.md`

### Reference
- `docs/CONFIG.md` (generated)
- `docs/LOG_TAGS.md` (generated)
- `docs/TUNING.md`

### Debugging
- `docs/DEBUGGING.md`

### Release history
- `docs/CHANGELOG.md`

## Module Load Order
Build order matters. The canonical load order is in `docs/ARCHITECTURE.md` and is synced from `build/manifest.json` (generated by `build/generate-manifest.js`).








