=================================================================================
                        FIX 1 - DEBOUNCE HANDLER
                           ‚≠ê CRITICAL FIX ‚≠ê
=================================================================================

WHY THIS FIX IS NEEDED:
The root cause of stream collapse is a "death spiral" where Twitch's player emits
multiple "Playhead stalling" warnings within seconds of each other (at 15:16:49,
15:16:52, 15:16:56 as seen in Log.txt). Currently, EVERY warning triggers an
immediate recovery attempt. These rapid-fire recoveries exhaust the video buffer
faster than it can refill, degrading readyState from 4‚Üí3‚Üí2‚Üí1 until the stream
is completely dead.

WHAT THIS FIX DOES:
Implement a 10-second debounce that allows maximum ONE recovery trigger per
10-second window. This breaks the death spiral at its source by preventing the
rapid recovery loop, giving the buffer time to stabilize between attempts.

WHY 10 SECONDS:
- Buffer refill time: 2-3 seconds
- Recovery execution: 2-3 seconds  
- Safety margin: 4-5 seconds
- Total: ~10 seconds ensures recovery completes before next attempt

IMPACT: This is the MOST CRITICAL fix. Without it, Fixes 2 and 3 won't help.

---
artifact: task
name: Fix 1 - Debounce Playhead Stalling Handler
description: Detailed implementation guide to prevent rapid-fire recovery triggers by debouncing playhead stalling warnings
issue_id: Fix 1
priority: CRITICAL
file: Code.js
version: 1.19 ‚Üí 1.20
estimated_time: 10 minutes
parent_task: TASK_FIX_STREAM_COLLAPSE.md
---

# Task: Fix 1 - Debounce Playhead Stalling Handler

**Issue ID:** Fix 1  
**Priority:** CRITICAL  
**File:** `Code.js`  
**Version:** 1.19 ‚Üí 1.20  
**Estimated Time:** 10 minutes  

---

## üéØ Objective

Prevent rapid-fire recovery triggers from "Playhead stalling" warnings by implementing a debounced handler with a 10-second cooldown period.

**Problem:** Currently every "Playhead stalling" warning triggers immediate recovery, causing multiple recoveries within seconds (e.g., at 15:16:49, 15:16:52, 15:16:56), which exhausts the buffer and kills the stream.

**Solution:** Only allow ONE recovery trigger per 10-second window using the existing `Fn.debounce` utility.

---

## üìã Pre-Implementation Checklist

- [ ] Current `Code.js` is version 1.19
- [ ] Backup created: `Code_v1.19_backup.js`
- [ ] File is not currently open in browser (close Tampermonkey editor)
- [ ] Ready to test in browser after changes

---

## üîß Implementation Steps

### Step 0: Verify Code Structure (CRITICAL - Do This First!)
**Action:** Confirm the code matches expected structure before making changes

**Open Code.js and verify these exact lines exist:**

**Line 2-3 Check:**
```javascript
// @name          Mega Ad Dodger 3000 (Stealth Reactor Core) 1.19
// @version       1.19
```
- [ ] Line 2 shows version 1.19
- [ ] Line 3 shows version 1.19

**Line 317-319 Check (where Step 3 code will be inserted):**
```javascript
                // Intercept console.warn (useful for player warnings)
                const originalWarn = console.warn;
                console.warn = (...args) => {
```
- [ ] Line 317 has comment about console.warn
- [ ] Line 318 has `const originalWarn = console.warn;`
- [ ] Line 319 has `console.warn = (...args) => {`
- [ ] **NO** `playheadStallingDebounced` exists yet

**Line 361-364 Check (where Step 4 code will be modified):**
```javascript
                        // Critical warnings that trigger recovery
                        if (msg.includes('Playhead stalling')) {
                            Logger.add('Critical warning detected: Playhead stalling');
                            Adapters.EventBus.emit(CONFIG.events.AD_DETECTED);
                        }
```
- [ ] Line 361 has comment about critical warnings
- [ ] Line 362 has `if (msg.includes('Playhead stalling'))`
- [ ] Line 363 has `Logger.add('Critical warning detected: Playhead stalling');`
- [ ] Line 364 has `Adapters.EventBus.emit(CONFIG.events.AD_DETECTED);`

**Line 125-141 Check (verify Fn.debounce exists):**
- [ ] Search for `debounce: (func, delay)` - should find it in Fn object
- [ ] Debounce function exists and is complete

**‚ö†Ô∏è IF ANY OF THE ABOVE DON'T MATCH:**
- STOP - Do not proceed
- File may have been modified from v1.19
- Report mismatch and ask for guidance

---

### Step 1: Create Backup
**Action:** Copy current Code.js to backup file

```powershell
# Run in project directory
Copy-Item "Code.js" "Code_v1.19_backup.js"
```

**Validation:**
- [ ] `Code_v1.19_backup.js` exists
- [ ] Backup file has same size as `Code.js`

---

### Step 2: Update Version Number
**File:** `Code.js`  
**Line:** 2-3  

**Current Code:**
```javascript
// @name          Mega Ad Dodger 3000 (Stealth Reactor Core) 1.19
// @version       1.19
```

**New Code:**
```javascript
// @name          Mega Ad Dodger 3000 (Stealth Reactor Core) 1.20
// @version       1.20
```

**Validation:**
- [ ] Line 2 shows version 1.20
- [ ] Line 3 shows version 1.20
- [ ] Both lines match

---

### Step 3: Add Debounced Function Declaration
**File:** `Code.js`  
**Exact Location:** Between lines 318-319  
**Context:** Inside the `Logger.init()` function, after the `originalWarn` declaration

**üîç Find this EXACT code block (lines 317-319):**
```javascript
                // Intercept console.warn (useful for player warnings)
                const originalWarn = console.warn;
                console.warn = (...args) => {
```

**‚úèÔ∏è INSERT BETWEEN line 318 and 319 (after `originalWarn` declaration, before `console.warn = `):**

**‚ö†Ô∏è IMPORTANT - Match indentation EXACTLY (16 spaces / 4 levels):**
```javascript
                
                // Debounced handler for playhead stalling warnings
                // Prevents rapid-fire recovery triggers that exhaust buffer
                const playheadStallingDebounced = Fn.debounce(() => {
                    Logger.add('Critical warning detected: Playhead stalling (debounced - max 1 per 10s)');
                    Adapters.EventBus.emit(CONFIG.events.AD_DETECTED);
                }, 10000); // 10-second debounce window
```

**üìç Result should look like:**
```javascript
                // Intercept console.warn (useful for player warnings)
                const originalWarn = console.warn;
                
                // Debounced handler for playhead stalling warnings  ‚Üê NEW CODE STARTS HERE
                // Prevents rapid-fire recovery triggers that exhaust buffer
                const playheadStallingDebounced = Fn.debounce(() => {
                    Logger.add('Critical warning detected: Playhead stalling (debounced - max 1 per 10s)');
                    Adapters.EventBus.emit(CONFIG.events.AD_DETECTED);
                }, 10000); // 10-second debounce window  ‚Üê NEW CODE ENDS HERE
                
                console.warn = (...args) => {
```

**Validation:**
- [ ] Code inserted between lines 318-319 (after `originalWarn`, before `console.warn =`)
- [ ] ALL lines use 16 spaces for base indentation (4 levels)
- [ ] Arrow function body uses 20 spaces for indentation (5 levels)
- [ ] Debounce delay is exactly `10000` (not 1000 or other value)
- [ ] No syntax errors (check editor highlighting)

---

### Step 4: Update Playhead Stalling Trigger Logic
**File:** `Code.js`  
**Lines:** 361-364  
**Action:** REPLACE existing code (not add to it)

üîç **Find These Lines (361-364):**
```javascript
                        // Critical warnings that trigger recovery
                        if (msg.includes('Playhead stalling')) {
                            Logger.add('Critical warning detected: Playhead stalling');
                            Adapters.EventBus.emit(CONFIG.events.AD_DETECTED);
                        }
```

‚ö†Ô∏è **DELETE lines 363-364** (the two lines inside the if block)

‚úèÔ∏è **REPLACE with this new code:**
```javascript
                        // Critical warnings that trigger recovery
                        if (msg.includes('Playhead stalling')) {
                            Logger.add('Playhead stalling warning detected (raw)', { 
                                message: msg,
                                timestamp: new Date().toISOString()
                            });
                            playheadStallingDebounced(); // Debounced - max 1 trigger per 10s
                        }
```

üìù **What Changed:**
1. **Line 363 BEFORE:** `Logger.add('Critical warning detected: Playhead stalling');`  
   **Line 363-365 AFTER:** Logger.add with object containing message and timestamp (3 lines)
   
2. **Line 364 BEFORE:** `Adapters.EventBus.emit(CONFIG.events.AD_DETECTED);`  
   **Line 366 AFTER:** `playheadStallingDebounced();` ‚Üê **This is the key change**

**Validation:**
- [ ] Line 363 now starts with `Logger.add('Playhead stalling warning detected (raw)'`
- [ ] Lines 364-365 contain message and timestamp properties (object)
- [ ] Line 366 contains `playheadStallingDebounced()` call
- [ ] **REMOVED:** Direct `Adapters.EventBus.emit` call (now handled by debounced function)
- [ ] Comment updated to mention debouncing
- [ ] Total if block is now 5 lines instead of 3

---

### Step 5: Verify Debounce Function Exists
**File:** `Code.js`  
**Lines:** 125-141  

**Find this code block to confirm `Fn.debounce` is available:**
```javascript
        debounce: (func, delay) => {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    try {
                        func.apply(this, args);
                    } catch (error) {
                        Logger.add('Debounce error', {
                            function: func.name || 'anonymous',
                            error: error.message,
                            stack: error.stack
                        });
                    }
                }, delay);
            };
        }
```

**Validation:**
- [ ] `Fn.debounce` function exists in code
- [ ] Function accepts `func` and `delay` parameters
- [ ] Error handling is present

---

### Step 6: Post-Implementation Verification (Before Browser Testing)
**Action:** Verify all changes were applied correctly

**Quick Syntax Check:**
1. Save Code.js
2. Look for any red/error highlighting in editor
3. Search for `playheadStallingDebounced` using Ctrl+F

**Expected Results:**
- [ ] Search finds **exactly 2 occurrences**:
  - **First occurrence** (line ~323): Declaration in Logger.init() 
  - **Second occurrence** (line ~368): Call in playhead stalling handler
- [ ] Version shows 1.20 (lines 2 and 3)
- [ ] No syntax errors or red highlights in editor
- [ ] File saved successfully

**Visual Verification - Check These Lines:**

**Lines 318-326 should look like:**
```javascript
                const originalWarn = console.warn;
                
                // Debounced handler for playhead stalling warnings
                // Prevents rapid-fire recovery triggers that exhaust buffer
                const playheadStallingDebounced = Fn.debounce(() => {
                    Logger.add('Critical warning detected: Playhead stalling (debounced - max 1 per 10s)');
                    Adapters.EventBus.emit(CONFIG.events.AD_DETECTED);
                }, 10000); // 10-second debounce window
                
                console.warn = (...args) => {
```

**Lines 361-369 should look like:**
```javascript
                        // Critical warnings that trigger recovery
                        if (msg.includes('Playhead stalling')) {
                            Logger.add('Playhead stalling warning detected (raw)', { 
                                message: msg,
                                timestamp: new Date().toISOString()
                            });
                            playheadStallingDebounced(); // Debounced - max 1 trigger per 10s
                        }
```

**Final Checks:**
- [ ] Both code blocks match the expected structure above
- [ ] All indentation looks consistent
- [ ] No missing braces or parentheses
- [ ] Ready to test in browser

**‚ö†Ô∏è If verification fails:**
- Restore from backup: `Copy-Item "Code_v1.19_backup.js" "Code.js" -Force`
- Review Steps 2-4 carefully
- Try implementation again

---

## üß™ Testing Procedure

### Pre-Test Validation
- [ ] Code.js saved with all changes
- [ ] **No syntax errors** (check editor syntax highlighting - should be normal colors)
- [ ] File encoding is UTF-8
- [ ] Line endings are consistent (CRLF for Windows)
- [ ] **Syntax check:** Search for `playheadStallingDebounced` - should appear exactly 2 times:
  - Once at declaration (Step 3)
  - Once at call site (Step 4)

### Browser Testing

#### Test 1: Script Loads Successfully
1. Open Tampermonkey dashboard
2. Click "Code.js" to open editor
3. Paste updated code or reload from file
4. Save script
5. Navigate to Twitch.tv stream

**Expected Result:**
- [ ] No console errors on page load
- [ ] Script initializes successfully
- [ ] See "Core initialized" in logs

#### Test 2: Playhead Stalling Detection
1. Watch stream until "Playhead stalling" warning appears
2. Check console logs immediately

**Expected Logs:**
```
[timestamp] Playhead stalling warning detected (raw) | {"message":"Playhead stalling at X.XXX, buffer end Y.YYY","timestamp":"..."}
[timestamp] Critical warning detected: Playhead stalling (debounced - max 1 per 10s)
[timestamp] Event: AD_DETECTED
[timestamp] Resilience execution started
```

**Validation:**
- [ ] "Playhead stalling warning detected (raw)" appears for EVERY warning
- [ ] "Critical warning detected: Playhead stalling (debounced..." appears ONCE
- [ ] No additional recoveries for 10 seconds even if more warnings appear
- [ ] Resilience executes ONCE, not multiple times

#### Test 3: Debounce Cooldown Period
1. After first recovery, continue watching
2. If additional "Playhead stalling" warnings appear within 10 seconds, verify NO recovery triggers

**Expected Behavior:**
- [ ] Raw warnings logged but recovery NOT triggered
- [ ] After 10 seconds, if warning appears again, recovery CAN trigger
- [ ] Maximum 1 recovery per 10-second window

#### Test 4: Stream Stability
1. Let stream run for 10+ minutes
2. Monitor `resilience_executions` metric
3. Export logs with `exportTwitchAdLogs()`

**Expected Results:**
- [ ] Stream does NOT collapse
- [ ] `resilience_executions` count is LOW (ideally 0-2 over 10 minutes)
- [ ] No repeated recoveries in <10 second windows
- [ ] ReadyState stays at 3-4 (not degrading to 1-2)

---

## üìä Success Criteria

### Must Have (Critical)
- [x] Debounced function created with 10-second delay
- [x] Playhead stalling warnings call debounced handler
- [x] Maximum 1 recovery trigger per 10-second window
- [x] Script loads without errors
- [x] Stream does NOT collapse like before

### Nice to Have
- [ ] Detailed logging shows debounce behavior
- [ ] Metrics show reduced `resilience_executions` vs previous version
- [ ] User experience: smoother recovery with less interruption

---

## üö® Rollback Plan

If implementation fails or causes issues:

### Quick Rollback
```powershell
# Restore backup
Copy-Item "Code_v1.19_backup.js" "Code.js" -Force
```

### Validation After Rollback
- [ ] Version shows 1.19 again
- [ ] Original behavior restored
- [ ] Stream works as before (even if with same issue)

---

## üìù Implementation Notes

### Why 10 Seconds?
- Typical buffer refill time: 3-5 seconds
- Recovery execution time: 2-3 seconds
- Safety margin: 2-5 seconds
- **Total:** 10 seconds ensures recovery completes before next attempt

### Why Debounce Instead of Throttle?
- **Debounce:** Waits for quiet period (no new calls) before executing
- **Throttle:** Executes at fixed intervals regardless of call frequency
- **Choice:** Debounce prevents premature recovery during continuous warnings

### Expected Log Sequence (After Fix)
```
15:16:49.065 - Playhead stalling warning detected (raw)
15:16:49.065 - Critical warning detected: Playhead stalling (debounced - max 1 per 10s)
15:16:49.066 - Event: AD_DETECTED
15:16:49.066 - Resilience execution started
15:16:51.757 - Event: REPORT | {"status":"SUCCESS"}
15:16:52.702 - Playhead stalling warning detected (raw)  ‚Üê Logged but NO recovery
15:16:56.853 - Playhead stalling warning detected (raw)  ‚Üê Logged but NO recovery
15:17:00.000 - [Next recovery can trigger IF warning appears after 15:16:59]
```

---

## ‚ö†Ô∏è Common Pitfalls & Troubleshooting

### Pitfall 1: Wrong Indentation
**Symptom:** Syntax error or unexpected token  
**Cause:** Not matching the 16-space indentation  
**Fix:** Use editor's "show whitespace" feature, count exactly 16 spaces

### Pitfall 2: `playheadStallingDebounced is not defined`
**Symptom:** Console error when playhead stalling occurs  
**Cause:** Step 3 code not added, or added in wrong location  
**Fix:** Verify Step 3 code is between lines 318-319, inside `Logger.init()` function

### Pitfall 3: Debounce Not Working
**Symptom:** Recovery still triggers multiple times quickly  
**Cause:** Step 4 not updated - still calling `Adapters.EventBus.emit` directly  
**Fix:** Verify Step 4 - must call `playheadStallingDebounced()`, NOT `EventBus.emit`

### Pitfall 4: Script Doesn't Load
**Symptom:** Tampermonkey shows error, script won't run  
**Cause:** Syntax error or mismatched braces  
**Fix:** Use online JavaScript validator, check all braces match

---

## ‚úÖ Final Checklist

Before marking as complete:

- [ ] All code changes implemented correctly
- [ ] Version updated to 1.20 (lines 2 AND 3)
- [ ] Backup created and verified
- [ ] Script loads without errors in Tampermonkey
- [ ] `playheadStallingDebounced` appears exactly 2 times in code
- [ ] Debounce function works as expected
- [ ] Stream does NOT collapse during testing
- [ ] Logs show proper debounce behavior (raw warnings logged, recovery debounced)
- [ ] Ready to proceed to Fix 2 (if needed)

---

## üîÑ Next Steps

After successful implementation of Fix 1:

1. **Monitor Performance:** Watch stream for 30+ minutes, collect logs with `exportTwitchAdLogs()`
2. **Evaluate Need for Fix 2:** If recoveries still fail occasionally, implement Fix 2 (increase buffer refill time)
3. **Document Results:** Compare metrics (v1.19 vs v1.20) - focus on `resilience_executions` count

**If Fix 1 solves the issue completely:** No need for Fix 2 or Fix 3.  
**If recovery still fails occasionally:** Proceed with Fix 2 to improve recovery success rate.  
**If stream still collapses:** Review logs, check for different error patterns.
